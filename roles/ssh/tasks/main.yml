- name: Create .ssh directory
  ansible.builtin.file:
    path: "{{ ssh.dir }}"
    state: directory
    mode: "0700"

- name: Generate ssh keys
  community.crypto.openssh_keypair:
    path: "{{ ssh.dir }}/{{ key.filename }}"
    passphrase: "{{ key.passphrase | default(omit) }}"
    type: "{{ key.type }}"
    state: "{{ key.state | default(omit) }}"
    regenerate: "{{ key.regenerate | default(omit) }}"
  loop: "{{ ssh.generate_keys }}"
  loop_control:
    loop_var: key

- name: Deploy ssh keys
  ansible.posix.authorized_key:
    user: "{{ ansible_facts.user_id }}"
    state: present
    key: "{{ lookup('file', ssh.dir + '/' + key.filename + '.pub') }}"
  loop: "{{ ssh.generate_keys }}"
  loop_control:
    loop_var: key
